asyncapi: 2.4.0
info:
  title: PrintNanny OS Events
  version: 0.1.0
  description: This service publishes events related to PrintNanny OS
defaultContentType: "application/json"

channels:
  pi.{pi_id}.action.printnanny.cloud.auth:
    parameters:
      pi_id:
        description: The ID of the PrintNanny Pi/device
        schema:
          type: string
    subscribe:
      message:
        name: PrintNannyCloudAuthReply
        payload:
          $ref: "#/components/messages/PrintNannyCloudAuthReply"
    publish:
      message:
        name: PrintNannyCloudAuthRequest
        payload:
          $ref: "#/components/messages/PrintNannyCloudAuthRequest"

  pi.{pi_id}.action.dbus.org.freedesktop.systemd1.Manager.DisableUnit:
    parameters:
      pi_id:
        description: The ID of the PrintNanny Pi/device
        schema:
          type: string
    subscribe:
      message:
        name: SystemdManagerDisableUnitReply
        payload:
          $ref: "#/components/messages/SystemdManagerDisableUnitsReply"
    publish:
      message:
        name: SystemdManagerDisableUnitRequest
        payload:
          $ref: "#/components/messages/SystemdManagerDisableUnitsRequest"

  pi.{pi_id}.action.dbus.org.freedesktop.systemd1.Manager.EnableUnit:
    parameters:
      pi_id:
        description: The ID of the PrintNanny Pi/device
        schema:
          type: string
    subscribe:
      message:
        name: SystemdManagerDisableUnitReply
        payload:
          $ref: "#/components/messages/SystemdManagerEnableUnitsReply"
    publish:
      message:
        name: SystemdManagerDisableUnitRequest
        payload:
          $ref: "#/components/messages/SystemdManagerEnableUnitsRequest"

  pi.{pi_id}.action.dbus.org.freedesktop.systemd1.Manager.GetUnit:
    parameters:
      pi_id:
        description: The ID of the PrintNanny Pi/device
        schema:
          type: string
    subscribe:
      message:
        name: SystemdManagerGetUnitReply
        payload:
          $ref: "#/components/messages/SystemdManagerGetUnitReply"
    publish:
      message:
        name: SystemdManagerGetUnitRequest
        payload:
          $ref: "#/components/messages/SystemdManagerGetUnitRequest"

  pi.{pi_id}.action.dbus.org.freedesktop.systemd1.Manager.ReloadUnit:
    parameters:
      pi_id:
        description: The ID of the PrintNanny Pi/device
        schema:
          type: string
    subscribe:
      message:
        name: SystemdManagerReloadUnitReply
        payload:
          $ref: "#/components/messages/SystemdManagerReloadUnitReply"
    publish:
      message:
        name: SystemdManagerReloadUnitRequest
        payload:
          $ref: "#/components/messages/SystemdManagerReloadUnitRequest"

  pi.{pi_id}.action.dbus.org.freedesktop.systemd1.Manager.RestartUnit:
    parameters:
      pi_id:
        description: The ID of the PrintNanny Pi/device
        schema:
          type: string
    subscribe:
      message:
        name: SystemdManagerRestartUnitReply
        payload:
          $ref: "#/components/messages/SystemdManagerRestartUnitReply"
    publish:
      message:
        name: SystemdManagerRestartUnitRequest
        payload:
          $ref: "#/components/messages/SystemdManagerRestartUnitRequest"

  pi.{pi_id}.action.dbus.org.freedesktop.systemd1.Manager.StartUnit:
    parameters:
      pi_id:
        description: The ID of the PrintNanny Pi/device
        schema:
          type: string
    subscribe:
      message:
        name: SystemdManagerStartUnitReply
        payload:
          $ref: "#/components/messages/SystemdManagerStartUnitReply"
    publish:
      message:
        name: SystemdManagerStartUnitRequest
        payload:
          $ref: "#/components/messages/SystemdManagerStartUnitRequest"

  pi.{pi_id}.action.dbus.org.freedesktop.systemd1.Manager.StoptUnit:
    parameters:
      pi_id:
        description: The ID of the PrintNanny Pi/device
        schema:
          type: string
    subscribe:
      message:
        name: SystemdManagerStopUnitReply
        payload:
          $ref: "#/components/messages/SystemdManagerStopUnitReply"
    publish:
      message:
        name: SystemdManagerStopUnitRequest
        payload:
          $ref: "#/components/messages/SystemdManagerStopUnitRequest"

components:
  messages:
    PrintNannyCloudAuthRequest:
      messageId: PrintNannyCloudAuthRequest
      summary: "Store authentication token obtained through 2fa"
      description: "Performs device setup and stores PrintNanny Cloud authentication credentials obtained from 2fa challenge: https://api.printnanny.ai/api/schema/redoc/#tag/accounts/operation/accounts_2fa_auth_token_create"
      x-parser-schema-id: PrintNannyCloudAuthRequest
      payload:
        $ref: "#/components/schemas/PrintNannyCloudAuthRequest"

    PrintNannyCloudAuthReply:
      messageId: PrintNannyCloudAuthRequest
      summary: "Store authentication token obtained through 2fa"
      description: "Performs device setup and stores PrintNanny Cloud authentication credentials obtained from 2fa challenge: https://api.printnanny.ai/api/schema/redoc/#tag/accounts/operation/accounts_2fa_auth_token_create"
      x-parser-schema-id: PrintNannyCloudAuthReply
      payload:
        $ref: "#/components/schemas/PrintNannyCloudAuthReply"

    SystemdManagerDisableUnitsRequest:
      messageId: SystemdManagerDisableUnitsRequest
      x-parser-schema-id: SystemdManagerDisableUnitsRequest
      summary: "Disable one or more systemd unit files"
      payload:
        $ref: "#/components/schemas/SystemdManagerDisableUnitsRequest"

    SystemdManagerDisableUnitsReply:
      messageId: SystemdManagerDisableUnitsReply
      x-parser-schema-id: SystemdManagerDisableUnitsReply
      summary: "Response to SystemdManagerDisableUnitsRequest"
      payload:
        $ref: "#/components/schemas/SystemdManagerDisableUnitsReply"

    SystemdManagerEnableUnitsRequest:
      messageId: SystemdManagerEnableUnitsRequest
      x-parser-schema-id: SystemdManagerEnableUnitsRequest
      summary: "Enable one or more systemd unit files"
      payload:
        $ref: "#/components/schemas/SystemdManagerEnableUnitsRequest"

    SystemdManagerEnableUnitsReply:
      messageId: SystemdManagerEnableUnitsReply
      x-parser-schema-id: SystemdManagerEnableUnitsReply
      summary: "Response to SystemdManagerEnableUnitsRequest"
      payload:
        $ref: "#/components/schemas/SystemdManagerEnableUnitsReply"

    SystemdManagerGetUnitRequest:
      messageId: SystemdManagerUnitRequest
      x-parser-schema-id: SystemdManagerUnitRequest
      name: SystemdManagerUnitRequest
      summary: "Get systemd unit status/details, equivalent to dbus.org.freedesktop.systemd1.Manager.GetUnit"
      payload:
        $ref: "#/components/schemas/SystemdManagerUnitRequest"

    SystemdManagerGetUnitReply:
      messageId: SystemdManagerGetUnitReply
      x-parser-schema-id: SystemdManagerGetUnitReply
      summary: "Get systemd unit status/details, equivalent to dbus.org.freedesktop.systemd1.Manager.GetUnit"
      payload:
        $ref: "#/components/schemas/SystemdManagerGetUnitReply"

    SystemdManagerReloadUnitRequest:
      messageId: SystemdManagerReloadUnitRequest
      x-parser-schema-id: SystemdManagerUnitRequest
      summary: "Reload systemd unit"
      payload:
        $ref: "#/components/schemas/SystemdManagerUnitRequest"

    SystemdManagerReloadUnitReply:
      messageId: SystemdManagerReloadUnitReply
      x-parser-schema-id: SystemdManagerUnitJobReply
      summary: "Result of reloading systemd unit, returning job id if state changed."
      payload:
        $ref: "#/components/schemas/SystemdManagerUnitJobReply"

    SystemdManagerRestartUnitRequest:
      messageId: SystemdManagerRestartUnitRequest
      x-parser-schema-id: SystemdManagerUnitRequest
      summary: "Restart systemd unit"
      payload:
        $ref: "#/components/schemas/SystemdManagerUnitRequest"

    SystemdManagerRestartUnitReply:
      messageId: SystemdManagerRestartUnitReply
      x-parser-schema-id: SystemdManagerUnitJobReply
      summary: "Result of restarting systemd unit, returning job id if state changed."
      payload:
        $ref: "#/components/schemas/SystemdManagerUnitJobReply"

    SystemdManagerStartUnitRequest:
      messageId: SystemdManagerStartUnitRequest
      x-parser-schema-id: SystemdManagerUnitRequest
      summary: "Start systemd unit"
      payload:
        $ref: "#/components/schemas/SystemdManagerUnitRequest"

    SystemdManagerStartUnitReply:
      messageId: SystemdManagerStartUnitReply
      x-parser-schema-id: SystemdManagerUnitJobReply
      summary: "Result of starting systemd unit, returning job id if state changed."
      payload:
        $ref: "#/components/schemas/SystemdManagerUnitJobReply"

    SystemdManagerStopUnitRequest:
      messageId: SystemdManagerStopUnitRequest
      x-parser-schema-id: SystemdManagerUnitRequest
      summary: "Stop systemd unit"
      payload:
        $ref: "#/components/schemas/SystemdManagerUnitRequest"

    SystemdManagerStopUnitReply:
      messageId: SystemdManagerStopUnitReply
      x-parser-schema-id: SystemdManagerUnitJobReply
      summary: "Result of stopping systemd unit, returning job id if state changed."
      payload:
        $ref: "#/components/schemas/SystemdManagerUnitJobReply"

  schemas:
    PrintNannyCloudAuthReply:
      name: PrintNannyCloudAuthReply
      type: object
      additionalProperties: false
      properties:
        request:
          $ref: "#/components/schemas/PrintNannyCloudAuthRequest"
        status_code:
          type: integer
        msg:
          type: string
      required:
        - request
        - status_code
        - msg

    PrintNannyCloudAuthRequest:
      type: object
      additionalProperties: false
      properties:
        email:
          type: string
        api_token:
          type: string
        api_url:
          type: string
      required:
        - email
        - api_token
        - api_url

    SystemdUnit:
      type: object
      additionalProperties: false
      properties:
        id:
          type: string
        fragment_path:
          type: string
        active_state:
          $ref: "#/components/schemas/SystemdUnitActiveState"
        load_state:
          $ref: "#/components/schemas/SystemdUnitLoadState"
        unit_file_state:
          $ref: "#/components/schemas/SystemdUnitFileState"
    SystemdUnitActiveState:
      type: string
      additionalProperties: false
      enum:
        - "active"
        - "activating"
        - "deactivating"
        - "inactive"
        - "reloading"
        - "loaded"
    SystemdUnitLoadState:
      type: string
      additionalProperties: false
      enum:
        - "loaded"
        - "error"
        - "masked"
    SystemdUnitFileState:
      type: string
      additionalProperties: false
      enum:
        - "enabled"
        - "enabled-runtime"
        - "linked"
        - "linked-runtime"
        - "static"
        - "disabled"
        - "invalid"
    SystemdUnitChange:
      type: object
      additionalProperties: false
      change:
        type: string
        enum:
          - "symlink"
          - "unlink"
      file:
        type: string
      destination:
        type: string
      required:
        - change
        - file
        - destination

    SystemdManagerEnableUnitsRequest:
      type: object
      additionalProperties: false
      properties:
        files:
          type: array
          items:
            type: string
          additionalItems: false
      required:
        - files

    SystemdManagerEnableUnitsReply:
      additionalProperties: false
      type: object
      properties:
        request:
          $ref: "#/components/schemas/SystemdManagerEnableUnitsRequest"
        changes:
          type: array
          items:
            $ref: "#/components/schemas/SystemdUnitChange"
          additionalItems: false
      required:
        - request
        - changes

    SystemdManagerDisableUnitsRequest:
      type: object
      additionalProperties: false
      properties:
        files:
          type: array
          items:
            type: string
          additionalItems: false
      required:
        - files

    SystemdManagerDisableUnitsReply:
      additionalProperties: false
      type: object
      properties:
        request:
          $ref: "#/components/schemas/SystemdManagerDisableUnitsRequest"
        changes:
          type: array
          items:
            $ref: "#/components/schemas/SystemdUnitChange"
          additionalItems: false
      required:
        - request
        - changes

    SystemdManagerUnitRequest:
      type: object
      additionalProperties: false
      properties:
        unit_name:
          type: string
      required:
        - name

    SystemdManagerUnitJobReply:
      type: object
      additionalProperties: false
      properties:
        job:
          type: string
        unit:
          $ref: "#/components/schemas/SystemdUnit"
      required:
        - job
        - unit

    SystemdManagerGetUnitReply:
      type: object
      additionalProperties: false
      properties:
        unit:
          $ref: "#/components/schemas/SystemdUnit"
      required:
        - unit
