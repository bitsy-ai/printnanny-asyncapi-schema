asyncapi: 2.4.0
info:
  title: PrintNanny OS Action & Command Service
  version: 0.1.8
  description: PrintNanny OS remote actions and command handler service
defaultContentType: "application/json"

channels:
  # begin dbus API request/reply channels
  pi.{pi}.dbus.org.freedesktop.systemd1.Manager.DisableUnit:
    parameters:
      pi:
        $ref: "#/components/parameters/pi"
    subscribe:
      operationId: SystemdManagerDisableUnitsReply
      message:
        $ref: "#/components/messages/SystemdManagerDisableUnitsReply"
    publish:
      operationId: SystemdManagerDisableUnitsRequest
      message:
        $ref: "#/components/messages/SystemdManagerDisableUnitsRequest"

  pi.{pi}.dbus.org.freedesktop.systemd1.Manager.EnableUnit:
    parameters:
      pi:
        $ref: "#/components/parameters/pi"
    subscribe:
      operationId: SystemdManagerEnableUnitsReply
      message:
        $ref: "#/components/messages/SystemdManagerEnableUnitsReply"
    publish:
      operationId: SystemdManagerEnableUnitsRequest
      message:
        $ref: "#/components/messages/SystemdManagerEnableUnitsRequest"

  pi.{pi}.dbus.org.freedesktop.systemd1.Manager.GetUnit:
    parameters:
      pi:
        $ref: "#/components/parameters/pi"
    subscribe:
      operationId: SystemdManagerGetUnitReply
      message:
        $ref: "#/components/messages/SystemdManagerGetUnitReply"
    publish:
      operationId: SystemdManagerGetUnitRequest
      message:
        $ref: "#/components/messages/SystemdManagerGetUnitRequest"

  pi.{pi}.dbus.org.freedesktop.systemd1.Manager.ReloadUnit:
    parameters:
      pi:
        $ref: "#/components/parameters/pi"
    subscribe:
      operationId: SystemdManagerReloadUnitReply
      message:
        $ref: "#/components/messages/SystemdManagerReloadUnitReply"
    publish:
      operationId: SystemdManagerReloadUnitRequest
      message:
        $ref: "#/components/messages/SystemdManagerReloadUnitRequest"

  pi.{pi}.dbus.org.freedesktop.systemd1.Manager.RestartUnit:
    parameters:
      pi:
        $ref: "#/components/parameters/pi"
    subscribe:
      operationId: SystemdManagerRestartUnitReply
      message:
        $ref: "#/components/messages/SystemdManagerRestartUnitReply"
    publish:
      operationId: SystemdManagerRestartUnitRequest
      message:
        $ref: "#/components/messages/SystemdManagerRestartUnitRequest"

  pi.{pi}.dbus.org.freedesktop.systemd1.Manager.StartUnit:
    parameters:
      pi:
        $ref: "#/components/parameters/pi"
    subscribe:
      operationId: SystemdManagerStartUnitReply
      message:
        $ref: "#/components/messages/SystemdManagerStartUnitReply"
    publish:
      operationId: SystemdManagerStartUnitRequest
      message:
        $ref: "#/components/messages/SystemdManagerStartUnitRequest"

  pi.{pi}.dbus.org.freedesktop.systemd1.Manager.StoptUnit:
    parameters:
      pi:
        $ref: "#/components/parameters/pi"
    subscribe:
      operationId: SystemdManagerStopUnitReply
      message:
        $ref: "#/components/messages/SystemdManagerStopUnitReply"
    publish:
      operationId: SystemdManagerStopUnitRequest
      message:
        $ref: "#/components/messages/SystemdManagerStopUnitRequest"
  # end dbus api request/reply channels

  # begin settings request/reply channels
  pi.{pi}.settings.cloud.auth:
    parameters:
      pi:
        $ref: "#/components/parameters/pi"
    subscribe:
      operationId: PrintNannyCloudAuthReply
      message:
        $ref: "#/components/messages/PrintNannyCloudAuthReply"
    publish:
      operationId: PrintNannyCloudAuthReques
      message:
        $ref: "#/components/messages/PrintNannyCloudAuthRequest"

  pi.{pi}.settings.vcs.load:
    parameters:
      pi:
        $ref: "#/components/parameters/pi"
    subscribe:
      operationId: VersionControlledSettingsLoadReply
      message:
        $ref: "#/components/messages/SettingsLoadReply"
    publish:
      operationId: VersionControlledSettingsRequest
      message:
        $ref: "#/components/messages/SettingsLoadRequest"

  pi.{pi}.settings.vcs.apply:
    parameters:
      pi:
        $ref: "#/components/parameters/pi"
    subscribe:
      operationId: VersionControlledSettingsApplyReply
      message:
        $ref: "#/components/messages/SettingsApplyReply"
    publish:
      operationId: VersionControlledSettingsApplyRequest
      message:
        $ref: "#/components/messages/SettingsApplyRequest"

  pi.{pi}.settings.vcs.revert:
    parameters:
      pi:
        $ref: "#/components/parameters/pi"
    subscribe:
      operationId: VersionControlledSettingsRevertReply
      message:
        $ref: "#/components/messages/SettingsRevertReply"
    publish:
      operationId: VersionControlledSettingsRevertRequest
      message:
        $ref: "#/components/messages/SettingsRevertRequest"

components:
  messages:
    PrintNannyCloudAuthRequest:
      name: PrintNannyCloudAuthRequest
      summary: "Store authentication token obtained through 2fa"
      description: "Performs device setup and stores PrintNanny Cloud authentication credentials obtained from 2fa challenge: https://api.printnanny.ai/api/schema/redoc/#tag/accounts/operation/accounts_2fa_auth_token_create"
      payload:
        x-parser-schema-id: PrintNannyCloudAuthRequest
        type: object
        additionalProperties: false
        properties:
          email:
            type: string
          api_token:
            type: string
          api_url:
            type: string
        required:
          - email
          - api_token
          - api_url

    PrintNannyCloudAuthReply:
      name: PrintNannyCloudAuthReply
      summary: "Store authentication token obtained through 2fa"
      description: "Performs device setup and stores PrintNanny Cloud authentication credentials obtained from 2fa challenge: https://api.printnanny.ai/api/schema/redoc/#tag/accounts/operation/accounts_2fa_auth_token_create"
      payload:
        x-parser-schema-id: PrintNannyCloudAuthReply
        type: object
        additionalProperties: false
        properties:
          status_code:
            type: integer
          msg:
            type: string
        required:
          - request
          - status_code
          - msg

    SettingsLoadRequest:
      summary: "Load a settings file for browser editor"
      payload:
        x-parser-schema-id: SettingsLoadRequest
        type: object
        additionalProperties: false
        properties:
          app:
            $ref: "#/components/schemas/SettingsApp"
        required:
          - app

    SettingsLoadReply:
      summary: "Load a settings file for browser editor"
      payload:
        x-parser-schema-id: SettingsLoadReply
        type: object
        additionalProperties: false
        properties:
          app:
            $ref: "#/components/schemas/SettingsApp"
          files:
            type: array
            additionalItems: false
            items:
              $ref: "#/components/schemas/SettingsFile"
          git_head_commit:
            type: string
          git_history:
            type: array
            additionalItems: false
            items:
              $ref: "#/components/schemas/GitCommit"
        required:
          - app
          - files
          - git_head_commit
          - git_history

    SettingsApplyRequest:
      summary: "Apply changes to a settings file and run pre/post save hooks"
      payload:
        x-parser-schema-id: SettingsApplyRequest
        type: object
        additionalProperties: false
        properties:
          app:
            $ref: "#/components/schemas/SettingsApp"
          files:
            type: array
            additionalItems: false
            items:
              $ref: "#/components/schemas/SettingsFile"
          git_head_commit:
            type: string
          git_commit_msg:
            type: string
        required:
          - app
          - files
          - git_head_commit
          - git_commit_msg

    SettingsApplyReply:
      summary: "Apply changes to a settings file and run pre/post save hooks"
      payload:
        x-parser-schema-id: SettingsApplyReply
        type: object
        additionalProperties: false
        properties:
          app:
            $ref: "#/components/schemas/SettingsApp"
          files:
            type: array
            additionalItems: false
            items:
              $ref: "#/components/schemas/SettingsFile"
          git_head_commit:
            type: string
          git_history:
            type: array
            additionalItems: false
            items:
              $ref: "#/components/schemas/GitCommit"
        required:
          - format
          - filename
          - content
          - git_head_commit
          - git_history

    SettingsRevertRequest:
      summary: "Revert git commit and run pre/post save hooks associated with provided settings files."
      payload:
        x-parser-schema-id: SettingsRevertRequest
        type: object
        additionalProperties: false
        properties:
          app:
            $ref: "#/components/schemas/SettingsApp"
          files:
            type: array
            additionalItems: false
            items:
              $ref: "#/components/schemas/SettingsFile"
          git_commit:
            type: string
        required:
          - app
          - files
          - git_commit

    SettingsRevertReply:
      summary: "Revert changes to a settings file and run pre/post save hooks"
      payload:
        x-parser-schema-id: SettingsRevertReply
        type: object
        additionalProperties: false
        properties:
          app:
            $ref: "#/components/schemas/SettingsApp"
          files:
            type: array
            additionalItems: false
            $ref: "#/components/schemas/SettingsFile"
          git_head_commit:
            type: string
          git_history:
            type: array
            additionalItems: false
            items:
              $ref: "#/components/schemas/GitCommit"
        required:
          - app
          - files
          - git_head_commit
          - git_history

    SystemdManagerDisableUnitsRequest:
      summary: "Disable one or more systemd unit files"
      payload:
        x-parser-schema-id: SystemdManagerDisableUnitsRequest
        type: object
        additionalProperties: false
        properties:
          files:
            type: array
            items:
              type: string
            additionalItems: false
        required:
          - files

    SystemdManagerDisableUnitsReply:
      summary: "Response to SystemdManagerDisableUnitsRequest"
      payload:
        x-parser-schema-id: SystemdManagerDisableUnitsReply
        additionalProperties: false
        type: object
        properties:
          changes:
            type: array
            items:
              $ref: "#/components/schemas/SystemdUnitChange"
            additionalItems: false
        required:
          - request
          - changes

    SystemdManagerEnableUnitsRequest:
      summary: "Enable one or more systemd unit files"
      payload:
        x-parser-schema-id: SystemdManagerEnableUnitsRequest
        type: object
        additionalProperties: false
        properties:
          files:
            type: array
            items:
              type: string
            additionalItems: false
        required:
          - files

    SystemdManagerEnableUnitsReply:
      summary: "Response to SystemdManagerEnableUnitsRequest"
      payload:
        x-parser-schema-id: SystemdManagerEnableUnitsReply
        additionalProperties: false
        type: object
        properties:
          changes:
            type: array
            items:
              $ref: "#/components/schemas/SystemdUnitChange"
            additionalItems: false
        required:
          - request
          - changes

    SystemdManagerGetUnitRequest:
      summary: "Get systemd unit status/details, equivalent to dbus.org.freedesktop.systemd1.Manager.GetUnit"
      payload:
        x-parser-schema-id: SystemdManagerGetUnitRequest
        type: object
        additionalProperties: false
        properties:
          unit_name:
            type: string
        required:
          - name

    SystemdManagerGetUnitReply:
      summary: "Get systemd unit status/details, equivalent to dbus.org.freedesktop.systemd1.Manager.GetUnit"
      payload:
        x-parser-schema-id: SystemdManagerGetUnitReply
        type: object
        additionalProperties: false
        properties:
          unit:
            $ref: "#/components/schemas/SystemdUnit"
        required:
          - unit

    SystemdManagerReloadUnitRequest:
      summary: "Reload systemd unit"
      payload:
        x-parser-schema-id: SystemdManagerReloadUnitRequest
        type: object
        additionalProperties: false
        properties:
          unit_name:
            type: string
        required:
          - name

    SystemdManagerReloadUnitReply:
      summary: "Result of reloading systemd unit, returning job id if state changed."
      payload:
        x-parser-schema-id: SystemdManagerReloadUnitReply
        type: object
        additionalProperties: false
        properties:
          job:
            type: string
          unit:
            $ref: "#/components/schemas/SystemdUnit"
        required:
          - job
          - unit

    SystemdManagerRestartUnitRequest:
      summary: "Restart systemd unit"
      payload:
        x-parser-schema-id: SystemdManagerRestartUnitRequest
        type: object
        additionalProperties: false
        properties:
          unit_name:
            type: string
        required:
          - name

    SystemdManagerRestartUnitReply:
      summary: "Result of restarting systemd unit, returning job id if state changed."
      payload:
        x-parser-schema-id: SystemdManagerRestartUnitReply
        type: object
        additionalProperties: false
        properties:
          job:
            type: string
          unit:
            $ref: "#/components/schemas/SystemdUnit"
        required:
          - job
          - unit

    SystemdManagerStartUnitRequest:
      summary: "Start systemd unit"
      payload:
        x-parser-schema-id: SystemdManagerStartUnitRequest
        type: object
        additionalProperties: false
        properties:
          unit_name:
            type: string
        required:
          - name

    SystemdManagerStartUnitReply:
      summary: "Result of starting systemd unit, returning job id if state changed."
      payload:
        x-parser-schema-id: SystemdManagerStartUnitReply
        type: object
        additionalProperties: false
        properties:
          job:
            type: string
          unit:
            $ref: "#/components/schemas/SystemdUnit"
        required:
          - job
          - unit

    SystemdManagerStopUnitRequest:
      summary: "Stop systemd unit"
      payload:
        x-parser-schema-id: SystemdManagerStartUnitRequest
        type: object
        additionalProperties: false
        properties:
          unit_name:
            type: string
        required:
          - name

    SystemdManagerStopUnitReply:
      summary: "Result of stopping systemd unit, returning job id if state changed."
      payload:
        x-parser-schema-id: SystemdManagerStopUnitReply
        type: object
        additionalProperties: false
        properties:
          job:
            type: string
          unit:
            $ref: "#/components/schemas/SystemdUnit"
        required:
          - job
          - unit

  parameters:
    pi:
      description: The ID of the PrintNanny Pi/device
      schema:
        type: string
  schemas:
    GitCommit:
      name: GitHistory
      type: object
      additionalProperties: false
      properties:
        oid:
          type: string
        header:
          type: string
        message:
          type: string
        ts:
          type: integer
          format: long
      required:
        - oid
        - header
        - message
        - ts

    SettingsFile:
      name: SettingsFile
      summary: "A version controlled file"
      type: object
      additionalProperties: false
      properties:
        content:
          type: string
        file_name:
          type: string
        file_format:
          $ref: "#/components/schemas/SettingsFormat"
      required:
        - content
        - file_name
        - file_format

    SettingsFormat:
      type: string
      enum:
        - json
        - toml
        - yaml
        - ini

    SettingsApp:
      type: string
      enum:
        - octoprint
        - klipper
        - moonraker
        - printnanny

    SystemdUnit:
      type: object
      additionalProperties: false
      properties:
        id:
          type: string
        fragment_path:
          type: string
        active_state:
          $ref: "#/components/schemas/SystemdUnitActiveState"
        load_state:
          $ref: "#/components/schemas/SystemdUnitLoadState"
        unit_file_state:
          $ref: "#/components/schemas/SystemdUnitFileState"

      required:
        - id
        - fragment_path
        - active_state
        - load_state
        - unit_file_state

    SystemdUnitActiveState:
      type: string
      additionalProperties: false
      enum:
        - "active"
        - "activating"
        - "deactivating"
        - "inactive"
        - "reloading"
        - "loaded"
    SystemdUnitLoadState:
      type: string
      additionalProperties: false
      enum:
        - "loaded"
        - "error"
        - "masked"
    SystemdUnitFileState:
      type: string
      additionalProperties: false
      enum:
        - "enabled"
        - "enabled-runtime"
        - "linked"
        - "linked-runtime"
        - "static"
        - "disabled"
        - "invalid"
    SystemdUnitChange:
      type: object
      additionalProperties: false
      change:
        type: string
        enum:
          - "symlink"
          - "unlink"
      file:
        type: string
      destination:
        type: string
      required:
        - change
        - file
        - destination
