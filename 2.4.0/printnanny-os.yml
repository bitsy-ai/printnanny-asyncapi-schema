asyncapi: 2.4.0
info:
  title: PrintNanny OS Action & Command Service
  version: 0.1.2
  description: PrintNanny OS remote actions and command handler service
defaultContentType: "application/json"

channels:
  # begin dbus API request/reply channels
  pi.{pi_id}.dbus.org.freedesktop.systemd1.Manager.DisableUnit:
    parameters:
      pi_id:
        description: The ID of the PrintNanny Pi/device
        schema:
          type: string
    subscribe:
      message:
        name: SystemdManagerDisableUnitReply
        payload:
          $ref: "#/components/messages/SystemdManagerDisableUnitsReply"
    publish:
      message:
        name: SystemdManagerDisableUnitRequest
        payload:
          $ref: "#/components/messages/SystemdManagerDisableUnitsRequest"

  pi.{pi_id}.dbus.org.freedesktop.systemd1.Manager.EnableUnit:
    parameters:
      pi_id:
        description: The ID of the PrintNanny Pi/device
        schema:
          type: string
    subscribe:
      message:
        name: SystemdManagerDisableUnitReply
        payload:
          $ref: "#/components/messages/SystemdManagerEnableUnitsReply"
    publish:
      message:
        name: SystemdManagerDisableUnitRequest
        payload:
          $ref: "#/components/messages/SystemdManagerEnableUnitsRequest"

  pi.{pi_id}.dbus.org.freedesktop.systemd1.Manager.GetUnit:
    parameters:
      pi_id:
        description: The ID of the PrintNanny Pi/device
        schema:
          type: string
    subscribe:
      message:
        name: SystemdManagerGetUnitReply
        payload:
          $ref: "#/components/messages/SystemdManagerGetUnitReply"
    publish:
      message:
        name: SystemdManagerGetUnitRequest
        payload:
          $ref: "#/components/messages/SystemdManagerGetUnitRequest"

  pi.{pi_id}.dbus.org.freedesktop.systemd1.Manager.ReloadUnit:
    parameters:
      pi_id:
        description: The ID of the PrintNanny Pi/device
        schema:
          type: string
    subscribe:
      message:
        name: SystemdManagerReloadUnitReply
        payload:
          $ref: "#/components/messages/SystemdManagerReloadUnitReply"
    publish:
      message:
        name: SystemdManagerReloadUnitRequest
        payload:
          $ref: "#/components/messages/SystemdManagerReloadUnitRequest"

  pi.{pi_id}.dbus.org.freedesktop.systemd1.Manager.RestartUnit:
    parameters:
      pi_id:
        description: The ID of the PrintNanny Pi/device
        schema:
          type: string
    subscribe:
      message:
        name: SystemdManagerRestartUnitReply
        payload:
          $ref: "#/components/messages/SystemdManagerRestartUnitReply"
    publish:
      message:
        name: SystemdManagerRestartUnitRequest
        payload:
          $ref: "#/components/messages/SystemdManagerRestartUnitRequest"

  pi.{pi_id}.dbus.org.freedesktop.systemd1.Manager.StartUnit:
    parameters:
      pi_id:
        description: The ID of the PrintNanny Pi/device
        schema:
          type: string
    subscribe:
      message:
        name: SystemdManagerStartUnitReply
        payload:
          $ref: "#/components/messages/SystemdManagerStartUnitReply"
    publish:
      message:
        name: SystemdManagerStartUnitRequest
        payload:
          $ref: "#/components/messages/SystemdManagerStartUnitRequest"

  pi.{pi_id}.dbus.org.freedesktop.systemd1.Manager.StoptUnit:
    parameters:
      pi_id:
        description: The ID of the PrintNanny Pi/device
        schema:
          type: string
    subscribe:
      message:
        name: SystemdManagerStopUnitReply
        payload:
          $ref: "#/components/messages/SystemdManagerStopUnitReply"
    publish:
      message:
        name: SystemdManagerStopUnitRequest
        payload:
          $ref: "#/components/messages/SystemdManagerStopUnitRequest"
  # end dbus api request/reply channels

  # begin settings request/reply channels
  pi.{pi_id}.settings.printnanny.cloud.auth:
    parameters:
      pi_id:
        description: The ID of the PrintNanny Pi/device
        schema:
          type: string
    subscribe:
      message:
        name: PrintNannyCloudAuthReply
        payload:
          $ref: "#/components/messages/PrintNannyCloudAuthReply"
    publish:
      message:
        name: PrintNannyCloudAuthRequest
        payload:
          $ref: "#/components/messages/PrintNannyCloudAuthRequest"

  pi.{pi_id}.settings.printnanny.cam.load:
    parameters:
      pi_id:
        description: The ID of the PrintNanny Pi/device
        schema:
          type: string
    subscribe:
      message:
        name: PrintNannyCamSettingsLoadReply
        payload:
          $ref: "#/components/messages/SettingsLoadReply"
    publish:
      message:
        name: PrintNannyCamSettingsLoadRequest
        payload:
          $ref: "#/components/messages/SettingsLoadRequest"

  pi.{pi_id}.settings.printnanny.cam.apply:
    parameters:
      pi_id:
        description: The ID of the PrintNanny Pi/device
        schema:
          type: string
    subscribe:
      message:
        name: PrintNannyCamSettingsApplyReply
        payload:
          $ref: "#/components/messages/SettingsApplyReply"
    publish:
      message:
        name: PrintNannyCamSettingsApplyRequest
        payload:
          $ref: "#/components/messages/SettingsApplyRequest"

  pi.{pi_id}.settings.printnanny.cam.revert:
    parameters:
      pi_id:
        description: The ID of the PrintNanny Pi/device
        schema:
          type: string
    subscribe:
      message:
        name: PrintNannyCamSettingsRevertReply
        payload:
          $ref: "#/components/messages/SettingsRevertReply"
    publish:
      message:
        name: PrintNannyCamSettingsRevertRequest
        payload:
          $ref: "#/components/messages/SettingsRevertRequest"

  pi.{pi_id}.settings.klipper.load:
    parameters:
      pi_id:
        description: The ID of the PrintNanny Pi/device
        schema:
          type: string
    subscribe:
      message:
        name: KlipperSettingsLoadReply
        payload:
          $ref: "#/components/messages/SettingsLoadReply"
    publish:
      message:
        name: KlipperSettingsLoadRequest
        payload:
          $ref: "#/components/messages/SettingsLoadRequest"

  pi.{pi_id}.settings.klipper.apply:
    parameters:
      pi_id:
        description: The ID of the PrintNanny Pi/device
        schema:
          type: string
    subscribe:
      message:
        name: KlipperSettingsApplyReply
        payload:
          $ref: "#/components/messages/SettingsApplyReply"
    publish:
      message:
        name: KlipperSettingsApplyRequest
        payload:
          $ref: "#/components/messages/SettingsApplyRequest"

  pi.{pi_id}.settings.klipper.revert:
    parameters:
      pi_id:
        description: The ID of the PrintNanny Pi/device
        schema:
          type: string
    subscribe:
      message:
        name: KlipperSettingsRevertReply
        payload:
          $ref: "#/components/messages/SettingsRevertReply"
    publish:
      message:
        name: KlipperSettingsRevertRequest
        payload:
          $ref: "#/components/messages/SettingsRevertRequest"

  pi.{pi_id}.settings.moonraker.load:
    parameters:
      pi_id:
        description: The ID of the PrintNanny Pi/device
        schema:
          type: string
    subscribe:
      message:
        name: MoonrakerSettingsLoadReply
        payload:
          $ref: "#/components/messages/SettingsLoadReply"
    publish:
      message:
        name: MoonrakerSettingsLoadRequest
        payload:
          $ref: "#/components/messages/SettingsLoadRequest"

  pi.{pi_id}.settings.moonraker.apply:
    parameters:
      pi_id:
        description: The ID of the PrintNanny Pi/device
        schema:
          type: string
    subscribe:
      message:
        name: MoonrakerSettingsApplyReply
        payload:
          $ref: "#/components/messages/SettingsApplyReply"
    publish:
      message:
        name: MoonrakerSettingsApplyRequest
        payload:
          $ref: "#/components/messages/SettingsApplyRequest"

  pi.{pi_id}.settings.moonraker.revert:
    parameters:
      pi_id:
        description: The ID of the PrintNanny Pi/device
        schema:
          type: string
    subscribe:
      message:
        name: MoonrakerSettingsRevertReply
        payload:
          $ref: "#/components/messages/SettingsRevertReply"
    publish:
      message:
        name: MoonrakerSettingsRevertRequest
        payload:
          $ref: "#/components/messages/SettingsRevertRequest"

  pi.{pi_id}.settings.octoprint.load:
    parameters:
      pi_id:
        description: The ID of the PrintNanny Pi/device
        schema:
          type: string
    subscribe:
      message:
        name: OctoPrintSettingsLoadReply
        payload:
          $ref: "#/components/messages/SettingsLoadReply"
    publish:
      message:
        name: OctoPrintSettingsLoadRequest
        payload:
          $ref: "#/components/messages/SettingsLoadRequest"

  pi.{pi_id}.settings.octoprint.apply:
    parameters:
      pi_id:
        description: The ID of the PrintNanny Pi/device
        schema:
          type: string
    subscribe:
      message:
        name: OctoPrintSettingsApplyReply
        payload:
          $ref: "#/components/messages/SettingsApplyReply"
    publish:
      message:
        name: OctoPrintSettingsApplyRequest
        payload:
          $ref: "#/components/messages/SettingsApplyRequest"

  pi.{pi_id}.settings.octoprint.revert:
    parameters:
      pi_id:
        description: The ID of the PrintNanny Pi/device
        schema:
          type: string
    subscribe:
      message:
        name: OctoPrintSettingsRevertReply
        payload:
          $ref: "#/components/messages/SettingsRevertReply"
    publish:
      message:
        name: OctoPrintSettingsRevertRequest
        payload:
          $ref: "#/components/messages/SettingsRevertRequest"

components:
  messages:
    PrintNannyCloudAuthRequest:
      messageId: PrintNannyCloudAuthRequest
      summary: "Store authentication token obtained through 2fa"
      x-parser-schema-id: PrintNannyCloudAuthRequest
      description: "Performs device setup and stores PrintNanny Cloud authentication credentials obtained from 2fa challenge: https://api.printnanny.ai/api/schema/redoc/#tag/accounts/operation/accounts_2fa_auth_token_create"
      payload:
        x-parser-schema-id: PrintNannyCloudAuthRequest
        type: object
        additionalProperties: false
        properties:
          email:
            type: string
          api_token:
            type: string
          api_url:
            type: string
        required:
          - email
          - api_token
          - api_url

    PrintNannyCloudAuthReply:
      messageId: PrintNannyCloudAuthRequest
      summary: "Store authentication token obtained through 2fa"
      x-parser-schema-id: PrintNannyCloudAuthReply
      description: "Performs device setup and stores PrintNanny Cloud authentication credentials obtained from 2fa challenge: https://api.printnanny.ai/api/schema/redoc/#tag/accounts/operation/accounts_2fa_auth_token_create"
      payload:
        x-parser-schema-id: PrintNannyCloudAuthReply
        type: object
        additionalProperties: false
        properties:
          request:
            $ref: "#/components/messages/PrintNannyCloudAuthRequest"
          status_code:
            type: integer
          msg:
            type: string
        required:
          - request
          - status_code
          - msg

    SettingsLoadRequest:
      messageId: SettingsLoadRequest
      summary: "Load a settings file for browser editor"
      x-parser-schema-id: SettingsLoadRequest
      payload:
        x-parser-schema-id: SettingsLoadRequest
        type: object
        additionalProperties: false
        properties:
          format:
            $ref: "#/components/schemas/SettingsFormat"
          filename:
            $ref: "#/components/schemas/SettingsFile"

    SettingsLoadReply:
      messageId: SettingsLoadReply
      summary: "Load a settings file for browser editor"
      x-parser-schema-id: SettingsLoadReply
      payload:
        x-parser-schema-id: SettingsLoadReply
        type: object
        additionalProperties: false
        properties:
          format:
            $ref: "#/components/schemas/SettingsFormat"
          filename:
            $ref: "#/components/schemas/SettingsFile"
          content:
            type: string
          head_git_commit:
            type: string
          git_history:
            type: array
            additionalItems: false
            items:
              $ref: "#/components/schemas/GitCommit"
        required:
          - format
          - filename
          - content
          - head_git_commit
          - git_history

    SettingsApplyRequest:
      messageId: SettingsApplyRequest
      summary: "Apply changes to a settings file and run pre/post save hooks"
      x-parser-schema-id: SettingsApplyRequest
      payload:
        x-parser-schema-id: SettingsApplyRequest
        type: object
        additionalProperties: false
        properties:
          format:
            $ref: "#/components/schemas/SettingsFormat"
          filename:
            $ref: "#/components/schemas/SettingsFile"
          content:
            type: string
          head_git_commit:
            type: string
        required:
          - format
          - filename
          - content
          - head_git_commit

    SettingsApplyReply:
      messageId: SettingsApplyReply
      summary: "Apply changes to a settings file and run pre/post save hooks"
      x-parser-schema-id: SettingsApplyReply
      payload:
        x-parser-schema-id: SettingsApplyReply
        type: object
        additionalProperties: false
        properties:
          format:
            $ref: "#/components/schemas/SettingsFormat"
          filename:
            $ref: "#/components/schemas/SettingsFile"
          content:
            type: string
          head_git_commit:
            type: string
          git_history:
            type: array
            additionalItems: false
            items:
              $ref: "#/components/schemas/GitCommit"
        required:
          - format
          - filename
          - content
          - head_git_commit
          - git_history

    SettingsRevertRequest:
      messageId: SettingsRevertRequest
      summary: "Revert changes to a settings file and run pre/post save hooks"
      x-parser-schema-id: SettingsRevertRequest
      payload:
        x-parser-schema-id: SettingsRevertRequest
        type: object
        additionalProperties: false
        properties:
          git_commit:
            type: string
        required:
          - git_commit

    SettingsRevertReply:
      messageId: SettingsRevertReply
      summary: "Revert changes to a settings file and run pre/post save hooks"
      x-parser-schema-id: SettingsRevertReply
      payload:
        x-parser-schema-id: SettingsRevertReply
        type: object
        additionalProperties: false
        properties:
          format:
            $ref: "#/components/schemas/SettingsFormat"
          filename:
            $ref: "#/components/schemas/SettingsFile"
          content:
            type: string
          head_git_commit:
            type: string
          git_history:
            type: array
            additionalItems: false
            items:
              $ref: "#/components/schemas/GitCommit"
        required:
          - format
          - filename
          - content
          - head_git_commit
          - git_history

    SystemdManagerDisableUnitsRequest:
      messageId: SystemdManagerDisableUnitsRequest
      summary: "Disable one or more systemd unit files"
      x-parser-schema-id: SystemdManagerDisableUnitsRequest
      payload:
        x-parser-schema-id: SystemdManagerDisableUnitsRequest
        type: object
        additionalProperties: false
        properties:
          files:
            type: array
            items:
              type: string
            additionalItems: false
        required:
          - files

    SystemdManagerDisableUnitsReply:
      messageId: SystemdManagerDisableUnitsReply
      summary: "Response to SystemdManagerDisableUnitsRequest"
      x-parser-schema-id: SystemdManagerDisableUnitsReply
      payload:
        x-parser-schema-id: SystemdManagerDisableUnitsReply
        additionalProperties: false
        type: object
        properties:
          request:
            $ref: "#/components/messages/SystemdManagerDisableUnitsRequest"
          changes:
            type: array
            items:
              $ref: "#/components/schemas/SystemdUnitChange"
            additionalItems: false
        required:
          - request
          - changes

    SystemdManagerEnableUnitsRequest:
      messageId: SystemdManagerEnableUnitsRequest
      summary: "Enable one or more systemd unit files"
      x-parser-schema-id: SystemdManagerEnableUnitsRequest
      payload:
        x-parser-schema-id: SystemdManagerEnableUnitsRequest
        type: object
        additionalProperties: false
        properties:
          files:
            type: array
            items:
              type: string
            additionalItems: false
        required:
          - files

    SystemdManagerEnableUnitsReply:
      messageId: SystemdManagerEnableUnitsReply
      summary: "Response to SystemdManagerEnableUnitsRequest"
      x-parser-schema-id: SystemdManagerEnableUnitsReply
      payload:
        x-parser-schema-id: SystemdManagerEnableUnitsReply
        additionalProperties: false
        type: object
        properties:
          request:
            $ref: "#/components/messages/SystemdManagerEnableUnitsRequest"
          changes:
            type: array
            items:
              $ref: "#/components/schemas/SystemdUnitChange"
            additionalItems: false
        required:
          - request
          - changes

    SystemdManagerGetUnitRequest:
      messageId: SystemdManagerGetUnitRequest
      summary: "Get systemd unit status/details, equivalent to dbus.org.freedesktop.systemd1.Manager.GetUnit"
      x-parser-schema-id: SystemdManagerGetUnitRequest
      payload:
        x-parser-schema-id: SystemdManagerGetUnitRequest
        type: object
        additionalProperties: false
        properties:
          unit_name:
            type: string
        required:
          - name

    SystemdManagerGetUnitReply:
      messageId: SystemdManagerGetUnitReply
      summary: "Get systemd unit status/details, equivalent to dbus.org.freedesktop.systemd1.Manager.GetUnit"
      x-parser-schema-id: SystemdManagerGetUnitReply
      payload:
        x-parser-schema-id: SystemdManagerGetUnitReply
        type: object
        additionalProperties: false
        properties:
          unit:
            $ref: "#/components/schemas/SystemdUnit"
        required:
          - unit

    SystemdManagerReloadUnitRequest:
      messageId: SystemdManagerReloadUnitRequest
      summary: "Reload systemd unit"
      x-parser-schema-id: SystemdManagerReloadUnitRequest
      payload:
        x-parser-schema-id: SystemdManagerReloadUnitRequest
        type: object
        additionalProperties: false
        properties:
          unit_name:
            type: string
        required:
          - name

    SystemdManagerReloadUnitReply:
      messageId: SystemdManagerReloadUnitReply
      summary: "Result of reloading systemd unit, returning job id if state changed."
      x-parser-schema-id: SystemdManagerReloadUnitReply
      payload:
        x-parser-schema-id: SystemdManagerReloadUnitReply
        type: object
        additionalProperties: false
        properties:
          job:
            type: string
          unit:
            $ref: "#/components/schemas/SystemdUnit"
        required:
          - job
          - unit

    SystemdManagerRestartUnitRequest:
      messageId: SystemdManagerRestartUnitRequest
      summary: "Restart systemd unit"
      x-parser-schema-id: SystemdManagerRestartUnitRequest
      payload:
        x-parser-schema-id: SystemdManagerRestartUnitRequest
        type: object
        additionalProperties: false
        properties:
          unit_name:
            type: string
        required:
          - name

    SystemdManagerRestartUnitReply:
      messageId: SystemdManagerRestartUnitReply
      summary: "Result of restarting systemd unit, returning job id if state changed."
      x-parser-schema-id: SystemdManagerRestartUnitReply
      payload:
        x-parser-schema-id: SystemdManagerRestartUnitReply
        type: object
        additionalProperties: false
        properties:
          job:
            type: string
          unit:
            $ref: "#/components/schemas/SystemdUnit"
        required:
          - job
          - unit

    SystemdManagerStartUnitRequest:
      messageId: SystemdManagerStartUnitRequest
      summary: "Start systemd unit"
      x-parser-schema-id: SystemdManagerStartUnitRequest
      payload:
        x-parser-schema-id: SystemdManagerStartUnitRequest
        type: object
        additionalProperties: false
        properties:
          unit_name:
            type: string
        required:
          - name

    SystemdManagerStartUnitReply:
      messageId: SystemdManagerStartUnitReply
      summary: "Result of starting systemd unit, returning job id if state changed."
      x-parser-schema-id: SystemdManagerStartUnitReply
      payload:
        x-parser-schema-id: SystemdManagerStartUnitReply
        type: object
        additionalProperties: false
        properties:
          job:
            type: string
          unit:
            $ref: "#/components/schemas/SystemdUnit"
        required:
          - job
          - unit

    SystemdManagerStopUnitRequest:
      messageId: SystemdManagerStopUnitRequest
      summary: "Stop systemd unit"
      x-parser-schema-id: SystemdManagerStartUnitRequest
      payload:
        x-parser-schema-id: SystemdManagerStartUnitRequest
        type: object
        additionalProperties: false
        properties:
          unit_name:
            type: string
        required:
          - name

    SystemdManagerStopUnitReply:
      messageId: SystemdManagerStopUnitReply
      summary: "Result of stopping systemd unit, returning job id if state changed."
      x-parser-schema-id: SystemdManagerStopUnitReply
      payload:
        x-parser-schema-id: SystemdManagerStopUnitReply
        type: object
        additionalProperties: false
        properties:
          job:
            type: string
          unit:
            $ref: "#/components/schemas/SystemdUnit"
        required:
          - job
          - unit

  schemas:
    GitCommit:
      name: GitHistory
      type: object
      additionalProperties: false
      properties:
        oid:
          type: string
        header:
          type: string
        message:
          type: string
        ts:
          type: integer
      required:
        - oid
        - header
        - message
        - ts

    SettingsFormat:
      type: string
      enum:
        - json
        - toml
        - yaml
        - ini

    SettingsFile:
      type: string
      enum:
        - octoprint.yaml
        - klipper.cfg
        - moonraker.conf
        - printnanny.toml

    SystemdUnit:
      type: object
      additionalProperties: false
      properties:
        id:
          type: string
        fragment_path:
          type: string
        active_state:
          $ref: "#/components/schemas/SystemdUnitActiveState"
        load_state:
          $ref: "#/components/schemas/SystemdUnitLoadState"
        unit_file_state:
          $ref: "#/components/schemas/SystemdUnitFileState"

      required:
        - id
        - fragment_path
        - active_state
        - load_state
        - unit_file_state

    SystemdUnitActiveState:
      type: string
      additionalProperties: false
      enum:
        - "active"
        - "activating"
        - "deactivating"
        - "inactive"
        - "reloading"
        - "loaded"
    SystemdUnitLoadState:
      type: string
      additionalProperties: false
      enum:
        - "loaded"
        - "error"
        - "masked"
    SystemdUnitFileState:
      type: string
      additionalProperties: false
      enum:
        - "enabled"
        - "enabled-runtime"
        - "linked"
        - "linked-runtime"
        - "static"
        - "disabled"
        - "invalid"
    SystemdUnitChange:
      type: object
      additionalProperties: false
      change:
        type: string
        enum:
          - "symlink"
          - "unlink"
      file:
        type: string
      destination:
        type: string
      required:
        - change
        - file
        - destination
